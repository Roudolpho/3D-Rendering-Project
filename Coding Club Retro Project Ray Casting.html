<html lang="en">
<head>


<style>
#moveBtn {
	height:50px;
	width:200px;
	border:thin
}

button {
	padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
	height: 50px;
	width: 165px;
    display: block;
}
body {
    background-image: url("http://eskipaper.com/images/binary-wallpaper-4.jpg");
}
div {
    background-color: white;
}
td {
    background-color: white;
}
</style>


</head>


<body>
<table align="center">
<tr>
<td>
<!-- This first canvas will present the 2D interpretation for reference -->
<canvas id="topDownView" align="center" width="750" height="500" style="border:5px solid #000000;padding-left: 0;padding-right: 0;margin-left: auto;margin-right: auto;display: block">
</canvas>
</td>
<td>
<!-- This second canvas will present the 3D interpretation -->
<canvas id="rayCasting" align="center" width="750" height="500" style="border:5px solid #000000;padding-left: 0;padding-right: 0;margin-left: auto;margin-right: auto;display: block">
</canvas>
</td>
</tr>
<tr>
<td>
<!-- This input allows a user to change the room being tested -->
<form background-color="white">
  Room : <input id="room" type="number" name="quantity" value="4" min="1" max="10">
  
</form>
</td>
<td>
<div>
<!-- This input lets the user change the quality of the render -->
<form background-color="white">
  Quality (between 1 and 750): <input id="quantity" type="number" name="quantity" value="75" min="1" max="750">
  
</form>
</div>
</td>
</tr>
</table>




<script src='keyInput.js'></script>
<script src='player.js'></script>
<script src='mapCreation.js'></script>
<script>
//Miscelaneous---------------------------------------------------------------------------------------------------------------------------
function baseCon(value, base, baseTo) {// simple base converter for changing values of Hex-colors
	test = parseInt(Math.round(value), base).toString(baseTo);
	return test;
}
//END Miscelaneous---------------------------------------------------------------------------------------------------------------------------





//Drawing2D----------------------------------------------------------------------------------------------------------------------------------
PLAYERRADIUS = Player.radius/10;
function draw2DPlayer() {//draws the player in the 2D window
	var c = document.getElementById("topDownView");//references 2D canvas
	var ctx = c.getContext("2d");
	ctx.beginPath();//Draws player
    ctx.arc(Math.round(Player.x_pos/10), Math.round(Player.y_pos/10), PLAYERRADIUS, 0, 2 * Math.PI, false);
	ctx.lineWidth = 1;
	ctx.strokeStyle = 'blue';
    ctx.fillStyle = 'blue';
    ctx.fill();
	ctx.stroke();//ends drawing of player
	
	ctx.beginPath();//draws vision arc for field of view
    ctx.arc(Math.round(Player.x_pos/10), Math.round(Player.y_pos/10), PLAYERRADIUS*(5/4), Player.facing - (VISIONARC/2),Player.facing + (VISIONARC/2), false);
	ctx.lineWidth = 2;
    ctx.strokeStyle = '#770000';
    ctx.stroke();//ends drawing of field of view
	
	ctx.beginPath();//draws facing line
	ctx.moveTo(Math.round(Player.x_pos/10), Math.round(Player.y_pos/10));
	ctx.lineTo(Math.round(Player.x_pos/10)+(PLAYERRADIUS*(5/4)*Math.cos(Player.facing)), Math.round(Player.y_pos/10)+(PLAYERRADIUS*(5/4)*Math.sin(Player.facing)));
	ctx.stroke();//ends drawing of facing line
}
function draw2D(roomNumber) {//this function simply loads the next frame for the 2D window
	draw2DRoom(roomNumber);
	draw2DPlayer();
}
function draw2DRoom(roomNum) {//this function draws the room tiles for the 2D interpretation
	var c = document.getElementById("topDownView");
	var ctx = c.getContext("2d");
	ctx.beginPath();
	ctx.rect(0,0,c.width,c.height);
	ctx.fillStyle = '#007700';
	ctx.fill();
	ctx.stroke();
	for(y=0;y<maps[roomNum].length;y++){//draws all rows
		for(x=0;x<maps[roomNum][y].length;x++){//draws each collumn
			//console.log(maps[roomNum][y][x][0]);//for debugging purposes
			draw2DTile(maps[roomNum][y][x][0],x,y,roomNum);//draws the tile
		}
	}
}
function draw2DTile(value, x, y, roomNum) {//This is a function for drawing a specific tile to the canvas
	if(value == 0){
		
	} else {
		var c = document.getElementById("topDownView");
		var ctx = c.getContext("2d");
                var tileSizex = c.width / maps[roomNum][y].length;
                var tileSizey = c.height / maps[roomNum].length;
		//console.log(maps[roomNum][y][x][0]);
		if(value >= 250){
			ctx.fillStyle = getColorByTile(maps[roomNum][y][x][0]);
			ctx.fillRect((x)*tileSizex,(y)*tileSizey,tileSizex,tileSizey);
			ctx.fillStyle = getColorByTile(maps[roomNum][y][x][0]);
			
		}
		/*ctx.fillStyle = "#00FF00";
		ctx.font = "40px Arial";
		ctx.fillText(value,(500/maps[roomNum][y].length)*(x)+10,500/maps[roomNum].length*(y+1)-10);
		//50*(y+1)-5,50*(x)+5*/
	}
}
function getColorByTile(wallValue) {//gets the color of a tile and converts it to a hexcolor
	rVal = tileColors[wallValue][0];
	bVal = tileColors[wallValue][1];
	gVal = tileColors[wallValue][2];
	hexColor = "#"+hexSyntax(baseCon(rVal,10,16))+hexSyntax(baseCon(bVal,10,16))+hexSyntax(baseCon(gVal,10,16));
	//console.log(hexColor);
	return hexColor;
	
}
//END Drawing2D----------------------------------------------------------------------------------------------------------------------------------





//Draw 3D----------------------------------------------------------------------------------------------------------------------------------

wall = {distance:0,color:"",found:false,x_dis:0,y_dis:0,midDis:0,value:0,scaling:1.5};//this object is to help me organize my variables
var c2 = document.getElementById("rayCasting");
quality = c2.width/quantity;
function draw3DWalls(roomNum) {//Draws walls for the 3D interpretation
	for(x=0;x<c2.width/quality;x++){//draws to each pixel in the canvas width
		angle = (-(VISIONARC / 2)+(x*VISIONARC*quality/c2.width));//math to determine the angle corresponding to any given pixel on the canvas
		wall.found = false;wall.x_dis = 0;wall.y_dis = 0;//resets the variables in the wall object 
		do{//searches incremental for a wall tile in a specific direction
			wall.x_dis += 10*Math.cos(Player.facing + angle);//finds x distance
			wall.y_dis += 10*Math.sin(Player.facing + angle);//finds y distance
			xDist=Math.floor((Player.x_pos+wall.x_dis)/(c2.width*10/maps[roomNum][0].length));
			yDist=Math.floor((Player.y_pos+wall.y_dis)/(c2.height*10/maps[roomNum].length));
			if(maps[roomNum][yDist][xDist][0] >= 250){
				wall.found = true;
				wall.value = maps[roomNum][yDist][xDist][0];
				//wall.distance = wall.scaling*Math.abs(Math.sqrt((Math.pow(wall.y_dis,2) + Math.pow(wall.x_dis,2)))*Math.cos(angle));
				//This was an attempt to remove the fisheye, though it failed I have left it so I may study it later
                wall.distance = wall.scaling*Math.abs(Math.sqrt((Math.pow(wall.y_dis,2) + Math.pow(wall.x_dis,2)))*Math.cos(angle));
				if (x==250) {
					wall.midDis = wall.distance;//if the room tile is a wall, the wall is recorded
				}
			}
		}while(!wall.found);
		draw3DLine(x, quality)//draws a rectange representing a specific angle depending on the quality
	}
}
function draw3DLine(pixelNum, quality) {
	var c2 = document.getElementById("rayCasting");
	var ctx2 = c2.getContext("2d");
	color = getColorByDistance(wall.value,wall.distance);//takes the value to hexidecimal
        dist = wall.distance/100;
	if(dist<0){
		dist = 0;
	}
	for(n = 0;n<quality;n++){
		ctx2.beginPath();//draws pixel line
                ctx2.moveTo(pixelNum*quality + n, (dist+(c2.height/5)));//draws the sky
		ctx2.lineTo(pixelNum*quality + n,0);
		ctx2.strokeStyle = '#8888FF';
		ctx2.stroke();
		ctx2.beginPath();//draws pixel line
                ctx2.moveTo(pixelNum*quality + n, (dist+(c2.height/5)));//draws the bottom of the wall
		ctx2.lineTo(pixelNum*quality + n,((c2.height)-dist));//draws the top of the wall
		ctx2.strokeStyle = color;
		ctx2.stroke();
		ctx2.beginPath();//draws pixel line
                ctx2.moveTo(pixelNum*quality + n, c2.height);//draws the grass
		ctx2.lineTo(pixelNum*quality + n,((c2.height)-dist));
		ctx2.strokeStyle = '#007700';
		ctx2.stroke();
	}
}
function draw3DRoom(roomNum) {
	draw3DWalls(roomNum);//Draws the 3D room
	
}
function getColorByDistance(wallValue,dist) {//Determines the shading of a wall based on its distance from the player
	rVal = tileColors[wallValue][0];//initial red
	bVal = tileColors[wallValue][1];//initial blue
	gVal = tileColors[wallValue][2];//initial green
	rVal = hexBrighten(rVal*Math.pow(2,-(dist+16*Player.radius)/5000));//altered red
	bVal = hexBrighten(bVal*Math.pow(2,-(dist+16*Player.radius)/5000));//altered blue
	gVal = hexBrighten(gVal*Math.pow(2,-(dist+16*Player.radius)/5000));//altered green
	hexColor = "#"+hexSyntax(baseCon(rVal,10,16))+hexSyntax(baseCon(bVal,10,16))+hexSyntax(baseCon(gVal,10,16));//transfers to a hexcolor
	return hexColor;
	
}
function hexSyntax(value) {//adds a 0 if the translated value is only one character
	if(value.length==1){
		return ("0"+value);
	}
	return value;
}
function hexBrighten(value) {//alters the color for shading
	if(value<=200){
		return value =value*(5/4);
	}
	return value;
}
//END Draw 3D----------------------------------------------------------------------------------------------------------------------------------





//Update----------------------------------------------------------------------------------------------------------------------------------
function update() {//this is the function I use to run the program constantly
	if(document.getElementById("quantity").value<=750&&document.getElementById("quantity").value>=1){//checks the user input for the rendering quality
		quantity = document.getElementById("quantity").value;
		quality = c2.width/quantity;
	}
	if(document.getElementById("room").value<=maps.length-1&&document.getElementById("room").value>=1){//checks the user input for the room number
		Player.roomNum = document.getElementById("room").value-1;
	}
	checkInputs(Player.roomNum);
	checkFacing();
	
	//console.log(Player.facing);//For debugging purposes
}
setInterval(function() {update()},10);
function updateVisuals() {
	draw2D(Player.roomNum);
	draw3DRoom(Player.roomNum);
}
setInterval(function() {updateVisuals()},50);
//END Update----------------------------------------------------------------------------------------------------------------------------------





</script>
</body>
</html>